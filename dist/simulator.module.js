var d=class{static loop(){if(d.delayBetweenCycles===0)for(let t=0;t<d.CYCLES_PER_YIELD;t++){if(!this.computer.isRunning()){d.stop();break}this.computer.step()}else this.computer.step(),c.updateUI();d.updateOutputs(),this.computer.isRunning()&&setTimeout(()=>d.loop(),d.delayBetweenCycles)}static run(){this.computer.setRunning(!0),c.updateUI(),c.updateSpeedUI(),this.loop()}static stop(){this.computer.setRunning(!1),c.updateUI(),c.updateSpeedUI()}static updateOutputs(){this.computer.drawScreen(),this.computer.updateAudio()}static init(t){this.computer=t}static loadProgramAndReset(){this.computer.resetMemory();let t=c.getProgramText();console.log(t);try{this.computer.assembleAndLoadProgram(this.computer.parseProgramText(t))}catch(o){alert(o.message),console.error(o)}c.setLoadedProgramText(t),this.computer.resetCPU(),this.updateOutputs(),c.updateProgramMemoryView(),c.updateUI(),c.updateSpeedUI()}static stepOnce(){this.computer.setRunning(!0),this.computer.step(),this.computer.setRunning(!1),this.updateOutputs(),c.updateUI()}static runStop(){this.computer.isRunning()?this.stop():this.run()}},C=d;C.CYCLES_PER_YIELD=997,C.delayBetweenCycles=0;var E=C;var $=3100,x;(function(e){e[e.TOTAL_MEMORY_SIZE=3100]="TOTAL_MEMORY_SIZE",e[e.WORKING_MEMORY_START=0]="WORKING_MEMORY_START",e[e.WORKING_MEMORY_END=1e3]="WORKING_MEMORY_END",e[e.PROGRAM_MEMORY_START=1e3]="PROGRAM_MEMORY_START",e[e.PROGRAM_MEMORY_END=2e3]="PROGRAM_MEMORY_END",e[e.KEYCODE_0_ADDRESS=2e3]="KEYCODE_0_ADDRESS",e[e.KEYCODE_1_ADDRESS=2001]="KEYCODE_1_ADDRESS",e[e.KEYCODE_2_ADDRESS=2002]="KEYCODE_2_ADDRESS",e[e.MOUSE_X_ADDRESS=2010]="MOUSE_X_ADDRESS",e[e.MOUSE_Y_ADDRESS=2011]="MOUSE_Y_ADDRESS",e[e.MOUSE_PIXEL_ADDRESS=2012]="MOUSE_PIXEL_ADDRESS",e[e.MOUSE_BUTTON_ADDRESS=2013]="MOUSE_BUTTON_ADDRESS",e[e.RANDOM_NUMBER_ADDRESS=2050]="RANDOM_NUMBER_ADDRESS",e[e.CURRENT_TIME_ADDRESS=2051]="CURRENT_TIME_ADDRESS",e[e.VIDEO_MEMORY_START=2100]="VIDEO_MEMORY_START",e[e.VIDEO_MEMORY_END=3e3]="VIDEO_MEMORY_END",e[e.AUDIO_CH1_WAVE_TYPE_ADDRESS=3e3]="AUDIO_CH1_WAVE_TYPE_ADDRESS",e[e.AUDIO_CH1_FREQUENCY_ADDRESS=3001]="AUDIO_CH1_FREQUENCY_ADDRESS",e[e.AUDIO_CH1_VOLUME_ADDRESS=3002]="AUDIO_CH1_VOLUME_ADDRESS",e[e.AUDIO_CH2_WAVE_TYPE_ADDRESS=3003]="AUDIO_CH2_WAVE_TYPE_ADDRESS",e[e.AUDIO_CH2_FREQUENCY_ADDRESS=3004]="AUDIO_CH2_FREQUENCY_ADDRESS",e[e.AUDIO_CH2_VOLUME_ADDRESS=3005]="AUDIO_CH2_VOLUME_ADDRESS",e[e.AUDIO_CH3_WAVE_TYPE_ADDRESS=3006]="AUDIO_CH3_WAVE_TYPE_ADDRESS",e[e.AUDIO_CH3_FREQUENCY_ADDRESS=3007]="AUDIO_CH3_FREQUENCY_ADDRESS",e[e.AUDIO_CH3_VOLUME_ADDRESS=3008]="AUDIO_CH3_VOLUME_ADDRESS"})(x||(x={}));var r=x;var R={$(e){let t=document.querySelector(e);if(t==null)throw new Error(`couldn't find selector '${e}'`);return t},$Input(e){let t=R.$(e);if(t instanceof HTMLInputElement)return t;throw new Error("expected HTMLInputElement")},$TextArea(e){let t=R.$(e);if(t instanceof HTMLTextAreaElement)return t;throw new Error("expected HTMLTextAreaElement")},$Button(e){let t=R.$(e);if(t instanceof HTMLButtonElement)return t;throw new Error("expected HTMLButtonElement")},$Canvas(e){let t=R.$(e);if(t instanceof HTMLCanvasElement)return t;throw new Error("expected HTMLCanvasElement")},$Select(e){let t=R.$(e);if(t instanceof HTMLSelectElement)return t;throw new Error("expected HTMLSelectElement")},virtualizedScrollView(e,t,o,s,n){Object.assign(e.style,{height:`${t}px`,overflow:"auto"});let a=document.createElement("div");Object.assign(a.style,{height:`${o*s}px`,overflow:"hidden"}),e.appendChild(a);let l=document.createElement("div");a.appendChild(l);let g=10,N=()=>requestAnimationFrame(()=>{let H=Math.max(0,Math.floor(e.scrollTop/o)-g),P=Math.min(s,Math.ceil((e.scrollTop+t)/o)+g),B=H*o;l.style.transform=`translateY(${B}px)`,l.innerHTML=n(H,P)});return e.onscroll=N,N}},i=R;function u(e,t){let o=e+"",s=[o];for(let n=o.length;n<t;n++)s.push(" ");return s.join("")}var M=class{static initUI(t={}){this.programs=t;let o=i.$Select("#programSelector");Object.keys(t).forEach(s=>{let n=document.createElement("option");n.value=s,n.textContent=s,o.append(n)}),o.value=this.selectedProgram,this.selectProgram()}static getProgramText(){return i.$TextArea("#program").value}static getCanvas(){return i.$Canvas("#canvas")}static init(t){this.computer=t}static initScreen(t,o,s){let n="pixelated";/firefox/i.test(navigator.userAgent)&&(n="-moz-crisp-edges"),Object.assign(M.getCanvas(),{width:t,height:o}),Object.assign(M.getCanvas().style,{transformOrigin:"top left",transform:`scale(${s})`,"-ms-interpolation-mode":"nearest-neighbor",imageRendering:n})}static setLoadedProgramText(t){this.loadedProgramText=t,i.$Button("#loadProgramButton").disabled=!0}static updateLoadProgramButton(){i.$Button("#loadProgramButton").disabled=this.loadedProgramText===this.getProgramText()}static selectProgram(){this.selectedProgram=i.$Select("#programSelector").value,localStorage.setItem("selectedProgram",this.selectedProgram),i.$TextArea("#program").value=localStorage.getItem(this.selectedProgram)||this.programs[this.selectedProgram]||"",this.updateLoadProgramButton()}static editProgramText(){this.selectedProgram.startsWith("Custom")&&localStorage.setItem(this.selectedProgram,i.$TextArea("#program").value),this.updateLoadProgramButton()}static setSpeed(){E.delayBetweenCycles=-parseInt(i.$Input("#speed").value,10),this.updateSpeedUI()}static setFullSpeed(){let t=i.$Input("#full-speed");t&&t.checked?E.delayBetweenCycles=0:E.delayBetweenCycles=1,this.updateSpeedUI()}static updateSpeedUI(){let t=E.delayBetweenCycles===0,o=this.computer.isRunning()&&t;i.$Input("#full-speed").checked=t,i.$Input("#speed").value=String(-E.delayBetweenCycles),i.$("#debugger").classList.toggle("full-speed",o),i.$("#debuggerMessageArea").textContent=o?"debug UI disabled when CPU.running at full speed":""}static updateUI(){i.$Input("#programCounter").value=String(this.computer.getProgramCounter()),this.computer.isHalted()?(i.$("#running").textContent="halted",i.$Button("#stepButton").disabled=!0,i.$Button("#runButton").disabled=!0):(i.$("#running").textContent=this.computer.isRunning()?"running":"paused",i.$Button("#stepButton").disabled=!1,i.$Button("#runButton").disabled=!1),this.updateWorkingMemoryView(),this.updateInputMemoryView(),this.updateVideoMemoryView(),this.updateAudioMemoryView(),(E.delayBetweenCycles>300||!this.computer.isRunning())&&typeof this.scrollToProgramLine=="function"&&this.scrollToProgramLine(Math.max(0,this.computer.getProgramCounter()-r.PROGRAM_MEMORY_START-3))}static updateWorkingMemoryView(){let t=[];for(let o=r.WORKING_MEMORY_START;o<r.WORKING_MEMORY_END;o++)t.push(`${o}: ${this.computer.getMemory(o)}`);i.$TextArea("#workingMemoryView").textContent=t.join(`
`)}static scrollToProgramLine(t){i.$("#programMemoryView").scrollTop=t*this.itemHeight,Array.isArray(this.lines)&&this.lines.length&&this.renderProgramMemoryView()}static renderProgramMemoryView(){return i.virtualizedScrollView(i.$("#programMemoryView"),136,this.itemHeight,this.lines.length,(t,o)=>this.lines.slice(t,o).map((s,n)=>{let a=r.PROGRAM_MEMORY_START+t+n===this.computer.getProgramCounter();return`
  <pre
    class="table-row"
    style="height: ${this.itemHeight}px; background: ${a?"#eee":"none"}"
  >${s}</pre>
            `}).join(""))}static updateProgramMemoryView(){let t=[];for(let o=r.PROGRAM_MEMORY_START;o<r.PROGRAM_MEMORY_END;o++){let s=this.computer.getOpcodesToInstructions().get(this.computer.getMemory(o));if(t.push(`${u(o,4)}: ${u(this.computer.getMemory(o),8)} ${s||""}`),s){let n=this.computer.getInstructions()[s].operands;for(let a=0;a<n.length;a++)t.push(`${u(o+1+a,4)}: ${u(this.computer.getMemory(o+1+a),8)}   ${n[a][0]} (${n[a][1]})`);o+=n.length}}this.lines=t,Array.isArray(this.lines)&&this.lines.length&&this.renderProgramMemoryView(),this.lines=[]}static updateInputMemoryView(){i.$TextArea("#inputMemoryView").textContent=`${r.KEYCODE_0_ADDRESS}: ${u(this.computer.getMemory(r.KEYCODE_0_ADDRESS),8)} keycode 0
${r.KEYCODE_1_ADDRESS}: ${u(this.computer.getMemory(r.KEYCODE_1_ADDRESS),8)} keycode 1
${r.KEYCODE_2_ADDRESS}: ${u(this.computer.getMemory(r.KEYCODE_2_ADDRESS),8)} keycode 2
${r.MOUSE_X_ADDRESS}: ${u(this.computer.getMemory(r.MOUSE_X_ADDRESS),8)} mouse x
${r.MOUSE_Y_ADDRESS}: ${u(this.computer.getMemory(r.MOUSE_Y_ADDRESS),8)} mouse y
${r.MOUSE_PIXEL_ADDRESS}: ${u(this.computer.getMemory(r.MOUSE_PIXEL_ADDRESS),8)} mouse pixel
${r.MOUSE_BUTTON_ADDRESS}: ${u(this.computer.getMemory(r.MOUSE_BUTTON_ADDRESS),8)} mouse button
${r.RANDOM_NUMBER_ADDRESS}: ${u(this.computer.getMemory(r.RANDOM_NUMBER_ADDRESS),8)} random number
${r.CURRENT_TIME_ADDRESS}: ${u(this.computer.getMemory(r.CURRENT_TIME_ADDRESS),8)} current time`}static updateVideoMemoryView(){let t=[];for(let o=r.VIDEO_MEMORY_START;o<r.VIDEO_MEMORY_END;o++)t.push(`${o}: ${this.computer.getMemory(o)}`);i.$TextArea("#videoMemoryView").textContent=t.join(`
`)}static updateAudioMemoryView(){i.$TextArea("#audioMemoryView").textContent=`${r.AUDIO_CH1_WAVE_TYPE_ADDRESS}: ${u(this.computer.getMemory(r.AUDIO_CH1_WAVE_TYPE_ADDRESS),8)} audio ch1 wavetype
${r.AUDIO_CH1_FREQUENCY_ADDRESS}: ${u(this.computer.getMemory(r.AUDIO_CH1_FREQUENCY_ADDRESS),8)} audio ch1 frequency
${r.AUDIO_CH1_VOLUME_ADDRESS}: ${u(this.computer.getMemory(r.AUDIO_CH1_VOLUME_ADDRESS),8)} audio ch1 volume
${r.AUDIO_CH2_WAVE_TYPE_ADDRESS}: ${u(this.computer.getMemory(r.AUDIO_CH2_WAVE_TYPE_ADDRESS),8)} audio ch2 wavetype
${r.AUDIO_CH2_FREQUENCY_ADDRESS}: ${u(this.computer.getMemory(r.AUDIO_CH2_FREQUENCY_ADDRESS),8)} audio ch2 frequency
${r.AUDIO_CH2_VOLUME_ADDRESS}: ${u(this.computer.getMemory(r.AUDIO_CH2_VOLUME_ADDRESS),8)} audio ch2 volume
${r.AUDIO_CH3_WAVE_TYPE_ADDRESS}: ${u(this.computer.getMemory(r.AUDIO_CH3_WAVE_TYPE_ADDRESS),8)} audio ch3 wavetype
${r.AUDIO_CH3_FREQUENCY_ADDRESS}: ${u(this.computer.getMemory(r.AUDIO_CH3_FREQUENCY_ADDRESS),8)} audio ch3 frequency
${r.AUDIO_CH3_VOLUME_ADDRESS}: ${u(this.computer.getMemory(r.AUDIO_CH3_VOLUME_ADDRESS),8)} audio ch3 volume`}},_=M;_.selectedProgram=localStorage.getItem("selectedProgram")||"RandomPixels",_.loadedProgramText="",_.itemHeight=14,_.programs={};var c=_;var T=30,f=30,I=20;var y=class{static set(t,o){if(isNaN(o))throw new Error(`tried to write to an invalid value at ${t}`);if(t<0||t>=$)throw new Error("tried to write to an invalid memory address");this.ram[t]=o}static get(t){if(t<0||t>=$)throw new Error("tried to read from an invalid memory address");return this.ram[t]}};y.ram=[];var m=y;function U(e){if(e!=null)return e;throw new Error("unexpected null")}var W={"0":[0,0,0],"1":[255,255,255],"2":[255,0,0],"3":[0,255,0],"4":[0,0,255],"5":[255,255,0],"6":[0,255,255],"7":[255,0,255],"8":[192,192,192],"9":[128,128,128],"10":[128,0,0],"11":[128,128,0],"12":[0,128,0],"13":[128,0,128],"14":[0,128,128],"15":[0,0,128]},O=class{static getColor(t,o){let s=W[t];if(!s)throw new Error(`Invalid color code ${t} at address ${o}`);return s}static init(t){O.canvasCtx=t,this.imageData=t.createImageData(O.SCREEN_WIDTH,O.SCREEN_HEIGHT)}static drawScreen(){let t=U(this.imageData),o=r.VIDEO_MEMORY_END-r.VIDEO_MEMORY_START,s=t.data;for(let a=0;a<o;a++){let l=m.ram[r.VIDEO_MEMORY_START+a],g=this.getColor(l||"0",r.VIDEO_MEMORY_START+a);s[a*4]=g[0],s[a*4+1]=g[1],s[a*4+2]=g[2],s[a*4+3]=255}U(this.canvasCtx).putImageData(t,0,0)}},h=O;h.SCREEN_WIDTH=T,h.SCREEN_HEIGHT=f,h.SCREEN_PIXEL_SCALE=I;var w=h;var D=class{static init(t){if(!document.body)throw new Error("DOM not ready");document.body.onkeydown=n=>{D.keysPressed.add(n.key)},document.body.onkeyup=n=>{this.keysPressed.delete(n.key)},document.body.onmousedown=()=>{this.mouseDown=!0},document.body.onmouseup=()=>{this.mouseDown=!1};let o=t.getBoundingClientRect().top+window.scrollY,s=t.getBoundingClientRect().left+window.scrollX;t.onmousemove=n=>{this.mouseX=Math.floor((n.pageX-s)/w.SCREEN_PIXEL_SCALE),this.mouseY=Math.floor((n.pageY-o)/w.SCREEN_PIXEL_SCALE)}}static updateInputs(){let t=Array.from(D.keysPressed.values()).reverse();m.ram[r.KEYCODE_0_ADDRESS]=t[0]||0,m.ram[r.KEYCODE_1_ADDRESS]=t[1]||0,m.ram[r.KEYCODE_2_ADDRESS]=t[2]||0,m.ram[r.MOUSE_BUTTON_ADDRESS]=D.mouseDown?1:0,m.ram[r.MOUSE_X_ADDRESS]=D.mouseX,m.ram[r.MOUSE_Y_ADDRESS]=D.mouseY,m.ram[r.MOUSE_PIXEL_ADDRESS]=r.VIDEO_MEMORY_START+Math.floor(this.mouseY)*w.SCREEN_WIDTH+Math.floor(this.mouseX),m.ram[r.RANDOM_NUMBER_ADDRESS]=Math.floor(Math.random()*255),m.ram[r.CURRENT_TIME_ADDRESS]=Date.now()}},S=D;S.keysPressed=new Set,S.mouseDown=!1,S.mouseX=0,S.mouseY=0;var b=S;var p=class{static init(t){this.instructions=t,Object.keys(t).forEach(o=>{let s=t[o].opcode;this.instructionsToOpcodes.set(o,s),this.opcodesToInstructions.set(s,o)})}static step(){b.updateInputs();let t=this.advanceProgramCounter(),o=this.opcodesToInstructions.get(t);if(!o)throw new Error(`Unknown opcode '${t}'`);let s=this.instructions[o].operands.map(()=>this.advanceProgramCounter());this.instructions[o].execute.apply(null,s)}static advanceProgramCounter(){if(this.programCounter<r.PROGRAM_MEMORY_START||this.programCounter>=r.PROGRAM_MEMORY_END)throw new Error(`program counter outside valid program memory region at ${this.programCounter}`);return m.get(this.programCounter++)}static reset(){this.programCounter=r.PROGRAM_MEMORY_START,this.halted=!1,this.running=!1}};p.programCounter=r.PROGRAM_MEMORY_START,p.running=!1,p.halted=!1,p.instructionsToOpcodes=new Map,p.opcodesToInstructions=new Map;var L=p;var k=window.AudioContext||window.webkitAudioContext,Y={"0":"square","1":"sawtooth","2":"triangle","3":"sine"},A=class{static addAudioChannel(t,o,s){let n=this.audioCtx.createOscillator(),a=this.audioCtx.createGain();n.connect(a),a.connect(this.audioCtx.destination);let l={gain:0,oscillatorType:Y["0"],frequency:440};return a.gain.value=l.gain,n.type=l.oscillatorType,n.frequency.value=l.frequency,n.start(),this.audioChannels.push({state:l,waveTypeAddr:t,freqAddr:o,volAddr:s,gainNode:a,oscillatorNode:n})}static updateAudio(){this.audioChannels.forEach(t=>{let o=(m.ram[t.freqAddr]||0)/1e3,s=L.running?(m.ram[t.volAddr]||0)/100*this.MAX_GAIN:0,n=Y[m.ram[t.waveTypeAddr]]||Y["0"],{state:a}=t;a.gain!==s&&(t.gainNode.gain.setValueAtTime(s,this.audioCtx.currentTime),a.gain=s),a.oscillatorType!==n&&(t.oscillatorNode.type=n,a.oscillatorType=n),a.frequency!==o&&(t.oscillatorNode.frequency.setValueAtTime(o,this.audioCtx.currentTime),a.frequency=o)})}static init(){this.addAudioChannel(r.AUDIO_CH1_WAVE_TYPE_ADDRESS,r.AUDIO_CH1_FREQUENCY_ADDRESS,r.AUDIO_CH1_VOLUME_ADDRESS),this.addAudioChannel(r.AUDIO_CH2_WAVE_TYPE_ADDRESS,r.AUDIO_CH2_FREQUENCY_ADDRESS,r.AUDIO_CH2_VOLUME_ADDRESS),this.addAudioChannel(r.AUDIO_CH3_WAVE_TYPE_ADDRESS,r.AUDIO_CH3_FREQUENCY_ADDRESS,r.AUDIO_CH3_VOLUME_ADDRESS)}};A.MAX_GAIN=.15,A.audioChannels=[],A.audioCtx=new k;var V=A;function v(e,t){if(c.init(e),c.initScreen(T,f,I),c.initUI(t),E.init(e),E.loadProgramAndReset(),!document.body)throw new Error("DOM not ready");function o(){if(!document.body)throw new Error("DOM not ready");document.body.removeEventListener("click",o),V.audioCtx.resume()}return document.body.addEventListener("click",o),{selectProgram:()=>c.selectProgram(),loadProgramAndReset:()=>E.loadProgramAndReset(),runStop:()=>E.runStop(),stepOnce:()=>E.stepOnce(),editProgramText:()=>c.editProgramText(),setSpeed:()=>c.setSpeed(),setFullSpeed:()=>c.setFullSpeed()}}export{v as default};
