var p=class{static loop(){if(p.delayBetweenCycles===0)for(let t=0;t<p.CYCLES_PER_YIELD;t++){if(!this.computer.isRunning()){p.stop();break}this.computer.step()}else this.computer.step(),m.updateUI();p.updateOutputs(),this.computer.isRunning()&&setTimeout(()=>p.loop(),p.delayBetweenCycles)}static run(){this.computer.setRunning(!0),m.updateUI(),m.updateSpeedUI(),this.loop()}static stop(){this.computer.setRunning(!1),m.updateUI(),m.updateSpeedUI()}static updateOutputs(){this.computer.drawScreen(),this.computer.updateAudio()}static init(t){this.computer=t}static loadProgramAndReset(){this.computer.resetMemory();let t=m.getProgramText();console.log(t);try{this.computer.assembleAndLoadProgram(this.computer.parseProgramText(t))}catch(r){alert(r.message),console.error(r)}m.setLoadedProgramText(t),this.computer.resetCPU(),this.updateOutputs(),m.updateProgramMemoryView(),m.updateUI(),m.updateSpeedUI()}static stepOnce(){this.computer.setRunning(!0),this.computer.step(),this.computer.setRunning(!1),this.updateOutputs(),m.updateUI()}static runStop(){this.computer.isRunning()?this.stop():this.run()}},O=p;O.CYCLES_PER_YIELD=997,O.delayBetweenCycles=0;var l=O;var x=3100,Y;(function(o){o[o.TOTAL_MEMORY_SIZE=3100]="TOTAL_MEMORY_SIZE",o[o.WORKING_MEMORY_START=0]="WORKING_MEMORY_START",o[o.WORKING_MEMORY_END=1e3]="WORKING_MEMORY_END",o[o.PROGRAM_MEMORY_START=1e3]="PROGRAM_MEMORY_START",o[o.PROGRAM_MEMORY_END=2e3]="PROGRAM_MEMORY_END",o[o.KEYCODE_0_ADDRESS=2e3]="KEYCODE_0_ADDRESS",o[o.KEYCODE_1_ADDRESS=2001]="KEYCODE_1_ADDRESS",o[o.KEYCODE_2_ADDRESS=2002]="KEYCODE_2_ADDRESS",o[o.MOUSE_X_ADDRESS=2010]="MOUSE_X_ADDRESS",o[o.MOUSE_Y_ADDRESS=2011]="MOUSE_Y_ADDRESS",o[o.MOUSE_PIXEL_ADDRESS=2012]="MOUSE_PIXEL_ADDRESS",o[o.MOUSE_BUTTON_ADDRESS=2013]="MOUSE_BUTTON_ADDRESS",o[o.RANDOM_NUMBER_ADDRESS=2050]="RANDOM_NUMBER_ADDRESS",o[o.CURRENT_TIME_ADDRESS=2051]="CURRENT_TIME_ADDRESS",o[o.VIDEO_MEMORY_START=2100]="VIDEO_MEMORY_START",o[o.VIDEO_MEMORY_END=3e3]="VIDEO_MEMORY_END",o[o.AUDIO_CH1_WAVE_TYPE_ADDRESS=3e3]="AUDIO_CH1_WAVE_TYPE_ADDRESS",o[o.AUDIO_CH1_FREQUENCY_ADDRESS=3001]="AUDIO_CH1_FREQUENCY_ADDRESS",o[o.AUDIO_CH1_VOLUME_ADDRESS=3002]="AUDIO_CH1_VOLUME_ADDRESS",o[o.AUDIO_CH2_WAVE_TYPE_ADDRESS=3003]="AUDIO_CH2_WAVE_TYPE_ADDRESS",o[o.AUDIO_CH2_FREQUENCY_ADDRESS=3004]="AUDIO_CH2_FREQUENCY_ADDRESS",o[o.AUDIO_CH2_VOLUME_ADDRESS=3005]="AUDIO_CH2_VOLUME_ADDRESS",o[o.AUDIO_CH3_WAVE_TYPE_ADDRESS=3006]="AUDIO_CH3_WAVE_TYPE_ADDRESS",o[o.AUDIO_CH3_FREQUENCY_ADDRESS=3007]="AUDIO_CH3_FREQUENCY_ADDRESS",o[o.AUDIO_CH3_VOLUME_ADDRESS=3008]="AUDIO_CH3_VOLUME_ADDRESS"})(Y||(Y={}));var e=Y;var h={$(i){let t=document.querySelector(i);if(t==null)throw new Error(`couldn't find selector '${i}'`);return t},$Input(i){let t=h.$(i);if(t instanceof HTMLInputElement)return t;throw new Error("expected HTMLInputElement")},$TextArea(i){let t=h.$(i);if(t instanceof HTMLTextAreaElement)return t;throw new Error("expected HTMLTextAreaElement")},$Button(i){let t=h.$(i);if(t instanceof HTMLButtonElement)return t;throw new Error("expected HTMLButtonElement")},$Canvas(i){let t=h.$(i);if(t instanceof HTMLCanvasElement)return t;throw new Error("expected HTMLCanvasElement")},$Select(i){let t=h.$(i);if(t instanceof HTMLSelectElement)return t;throw new Error("expected HTMLSelectElement")},virtualizedScrollView(i,t,r,s,n){Object.assign(i.style,{height:`${t}px`,overflow:"auto"});let a=document.createElement("div");Object.assign(a.style,{height:`${r*s}px`,overflow:"hidden"}),i.appendChild(a);let d=document.createElement("div");a.appendChild(d);let R=10,H=()=>requestAnimationFrame(()=>{let b=Math.max(0,Math.floor(i.scrollTop/r)-R),P=Math.min(s,Math.ceil((i.scrollTop+t)/r)+R),B=b*r;d.style.transform=`translateY(${B}px)`,d.innerHTML=n(b,P)});return i.onscroll=H,H}},u=h;function c(i,t){let r=i+"",s=[r];for(let n=r.length;n<t;n++)s.push(" ");return s.join("")}var T=class{static initUI(t={}){this.programs=t;let r=u.$Select("#programSelector");Object.keys(t).forEach(s=>{let n=document.createElement("option");n.value=s,n.textContent=s,r.append(n)}),r.value=this.selectedProgram,this.selectProgram()}static getProgramText(){return u.$TextArea("#program").value}static getCanvas(){return u.$Canvas("#canvas")}static init(t){this.computer=t}static initScreen(t,r,s){let n="pixelated";/firefox/i.test(navigator.userAgent)&&(n="-moz-crisp-edges"),Object.assign(T.getCanvas(),{width:t,height:r}),Object.assign(T.getCanvas().style,{transformOrigin:"top left",transform:`scale(${s})`,"-ms-interpolation-mode":"nearest-neighbor",imageRendering:n})}static setLoadedProgramText(t){this.loadedProgramText=t,u.$Button("#loadProgramButton").disabled=!0}static updateLoadProgramButton(){u.$Button("#loadProgramButton").disabled=this.loadedProgramText===this.getProgramText()}static selectProgram(){this.selectedProgram=u.$Select("#programSelector").value,localStorage.setItem("selectedProgram",this.selectedProgram),u.$TextArea("#program").value=localStorage.getItem(this.selectedProgram)||this.programs[this.selectedProgram]||"",this.updateLoadProgramButton()}static editProgramText(){this.selectedProgram.startsWith("Custom")&&localStorage.setItem(this.selectedProgram,u.$TextArea("#program").value),this.updateLoadProgramButton()}static setSpeed(){l.delayBetweenCycles=-parseInt(u.$Input("#speed").value,10),this.updateSpeedUI()}static setFullSpeed(){let t=u.$Input("#full-speed");t&&t.checked?l.delayBetweenCycles=0:l.delayBetweenCycles=1,this.updateSpeedUI()}static updateSpeedUI(){let t=l.delayBetweenCycles===0,r=this.computer.isRunning()&&t;u.$Input("#full-speed").checked=t,u.$Input("#speed").value=String(-l.delayBetweenCycles),u.$("#debugger").classList.toggle("full-speed",r),u.$("#debuggerMessageArea").textContent=r?"debug UI disabled when CPU.running at full speed":""}static updateUI(){u.$Input("#programCounter").value=String(this.computer.getProgramCounter()),this.computer.isHalted()?(u.$("#running").textContent="halted",u.$Button("#stepButton").disabled=!0,u.$Button("#runButton").disabled=!0):(u.$("#running").textContent=this.computer.isRunning()?"running":"paused",u.$Button("#stepButton").disabled=!1,u.$Button("#runButton").disabled=!1),this.updateWorkingMemoryView(),this.updateInputMemoryView(),this.updateVideoMemoryView(),this.updateAudioMemoryView(),(l.delayBetweenCycles>300||!this.computer.isRunning())&&typeof this.scrollToProgramLine=="function"&&this.scrollToProgramLine(Math.max(0,this.computer.getProgramCounter()-e.PROGRAM_MEMORY_START-3))}static updateWorkingMemoryView(){let t=[];for(let r=e.WORKING_MEMORY_START;r<e.WORKING_MEMORY_END;r++)t.push(`${r}: ${this.computer.getMemory(r)}`);u.$TextArea("#workingMemoryView").textContent=t.join(`
`)}static scrollToProgramLine(t){u.$("#programMemoryView").scrollTop=t*this.itemHeight,Array.isArray(this.lines)&&this.lines.length&&this.renderProgramMemoryView()}static renderProgramMemoryView(){return u.virtualizedScrollView(u.$("#programMemoryView"),136,this.itemHeight,this.lines.length,(t,r)=>this.lines.slice(t,r).map((s,n)=>{let a=e.PROGRAM_MEMORY_START+t+n===this.computer.getProgramCounter();return`
  <pre
    class="table-row"
    style="height: ${this.itemHeight}px; background: ${a?"#eee":"none"}"
  >${s}</pre>
            `}).join(""))}static updateProgramMemoryView(){let t=[];for(let r=e.PROGRAM_MEMORY_START;r<e.PROGRAM_MEMORY_END;r++){let s=this.computer.getOpcodesToInstructions().get(this.computer.getMemory(r));if(t.push(`${c(r,4)}: ${c(this.computer.getMemory(r),8)} ${s||""}`),s){let n=this.computer.getInstructions()[s].operands;for(let a=0;a<n.length;a++)t.push(`${c(r+1+a,4)}: ${c(this.computer.getMemory(r+1+a),8)}   ${n[a][0]} (${n[a][1]})`);r+=n.length}}this.lines=t,Array.isArray(this.lines)&&this.lines.length&&this.renderProgramMemoryView(),this.lines=[]}static updateInputMemoryView(){u.$TextArea("#inputMemoryView").textContent=`${e.KEYCODE_0_ADDRESS}: ${c(this.computer.getMemory(e.KEYCODE_0_ADDRESS),8)} keycode 0
${e.KEYCODE_1_ADDRESS}: ${c(this.computer.getMemory(e.KEYCODE_1_ADDRESS),8)} keycode 1
${e.KEYCODE_2_ADDRESS}: ${c(this.computer.getMemory(e.KEYCODE_2_ADDRESS),8)} keycode 2
${e.MOUSE_X_ADDRESS}: ${c(this.computer.getMemory(e.MOUSE_X_ADDRESS),8)} mouse x
${e.MOUSE_Y_ADDRESS}: ${c(this.computer.getMemory(e.MOUSE_Y_ADDRESS),8)} mouse y
${e.MOUSE_PIXEL_ADDRESS}: ${c(this.computer.getMemory(e.MOUSE_PIXEL_ADDRESS),8)} mouse pixel
${e.MOUSE_BUTTON_ADDRESS}: ${c(this.computer.getMemory(e.MOUSE_BUTTON_ADDRESS),8)} mouse button
${e.RANDOM_NUMBER_ADDRESS}: ${c(this.computer.getMemory(e.RANDOM_NUMBER_ADDRESS),8)} random number
${e.CURRENT_TIME_ADDRESS}: ${c(this.computer.getMemory(e.CURRENT_TIME_ADDRESS),8)} current time`}static updateVideoMemoryView(){let t=[];for(let r=e.VIDEO_MEMORY_START;r<e.VIDEO_MEMORY_END;r++)t.push(`${r}: ${this.computer.getMemory(r)}`);u.$TextArea("#videoMemoryView").textContent=t.join(`
`)}static updateAudioMemoryView(){u.$TextArea("#audioMemoryView").textContent=`${e.AUDIO_CH1_WAVE_TYPE_ADDRESS}: ${c(this.computer.getMemory(e.AUDIO_CH1_WAVE_TYPE_ADDRESS),8)} audio ch1 wavetype
${e.AUDIO_CH1_FREQUENCY_ADDRESS}: ${c(this.computer.getMemory(e.AUDIO_CH1_FREQUENCY_ADDRESS),8)} audio ch1 frequency
${e.AUDIO_CH1_VOLUME_ADDRESS}: ${c(this.computer.getMemory(e.AUDIO_CH1_VOLUME_ADDRESS),8)} audio ch1 volume
${e.AUDIO_CH2_WAVE_TYPE_ADDRESS}: ${c(this.computer.getMemory(e.AUDIO_CH2_WAVE_TYPE_ADDRESS),8)} audio ch2 wavetype
${e.AUDIO_CH2_FREQUENCY_ADDRESS}: ${c(this.computer.getMemory(e.AUDIO_CH2_FREQUENCY_ADDRESS),8)} audio ch2 frequency
${e.AUDIO_CH2_VOLUME_ADDRESS}: ${c(this.computer.getMemory(e.AUDIO_CH2_VOLUME_ADDRESS),8)} audio ch2 volume
${e.AUDIO_CH3_WAVE_TYPE_ADDRESS}: ${c(this.computer.getMemory(e.AUDIO_CH3_WAVE_TYPE_ADDRESS),8)} audio ch3 wavetype
${e.AUDIO_CH3_FREQUENCY_ADDRESS}: ${c(this.computer.getMemory(e.AUDIO_CH3_FREQUENCY_ADDRESS),8)} audio ch3 frequency
${e.AUDIO_CH3_VOLUME_ADDRESS}: ${c(this.computer.getMemory(e.AUDIO_CH3_VOLUME_ADDRESS),8)} audio ch3 volume`}},S=T;S.selectedProgram=localStorage.getItem("selectedProgram")||"RandomPixels",S.loadedProgramText="",S.itemHeight=14,S.programs={};var m=S;var f=30,I=30,y=20;var U=class{static set(t,r){if(isNaN(r))throw new Error(`tried to write to an invalid value at ${t}`);if(t<0||t>=x)throw new Error("tried to write to an invalid memory address");this.ram[t]=r}static get(t){if(t<0||t>=x)throw new Error("tried to read from an invalid memory address");return this.ram[t]}};U.ram=[];var E=U;function w(i){if(i!=null)return i;throw new Error("unexpected null")}var W={"0":[0,0,0],"1":[255,255,255],"2":[255,0,0],"3":[0,255,0],"4":[0,0,255],"5":[255,255,0],"6":[0,255,255],"7":[255,0,255],"8":[192,192,192],"9":[128,128,128],"10":[128,0,0],"11":[128,128,0],"12":[0,128,0],"13":[128,0,128],"14":[0,128,128],"15":[0,0,128]},M=class{static getColor(t,r){let s=W[t];if(!s)throw new Error(`Invalid color code ${t} at address ${r}`);return s}static init(t){M.canvasCtx=t,this.imageData=t.createImageData(M.SCREEN_WIDTH,M.SCREEN_HEIGHT)}static drawScreen(){let t=w(this.imageData),r=e.VIDEO_MEMORY_END-e.VIDEO_MEMORY_START,s=t.data;for(let a=0;a<r;a++){let d=E.ram[e.VIDEO_MEMORY_START+a],R=this.getColor(d||"0",e.VIDEO_MEMORY_START+a);s[a*4]=R[0],s[a*4+1]=R[1],s[a*4+2]=R[2],s[a*4+3]=255}w(this.canvasCtx).putImageData(t,0,0)}},A=M;A.SCREEN_WIDTH=f,A.SCREEN_HEIGHT=I,A.SCREEN_PIXEL_SCALE=y;var $=A;var g=class{static init(t){if(!document.body)throw new Error("DOM not ready");document.body.onkeydown=n=>{g.keysPressed.add(n.key)},document.body.onkeyup=n=>{this.keysPressed.delete(n.key)},document.body.onmousedown=()=>{this.mouseDown=!0},document.body.onmouseup=()=>{this.mouseDown=!1};let r=t.getBoundingClientRect().top+window.scrollY,s=t.getBoundingClientRect().left+window.scrollX;t.onmousemove=n=>{this.mouseX=Math.floor((n.pageX-s)/$.SCREEN_PIXEL_SCALE),this.mouseY=Math.floor((n.pageY-r)/$.SCREEN_PIXEL_SCALE)}}static updateInputs(){let t=Array.from(g.keysPressed.values()).reverse();E.ram[e.KEYCODE_0_ADDRESS]=t[0]||0,E.ram[e.KEYCODE_1_ADDRESS]=t[1]||0,E.ram[e.KEYCODE_2_ADDRESS]=t[2]||0,E.ram[e.MOUSE_BUTTON_ADDRESS]=g.mouseDown?1:0,E.ram[e.MOUSE_X_ADDRESS]=g.mouseX,E.ram[e.MOUSE_Y_ADDRESS]=g.mouseY,E.ram[e.MOUSE_PIXEL_ADDRESS]=e.VIDEO_MEMORY_START+Math.floor(this.mouseY)*$.SCREEN_WIDTH+Math.floor(this.mouseX),E.ram[e.RANDOM_NUMBER_ADDRESS]=Math.floor(Math.random()*255),E.ram[e.CURRENT_TIME_ADDRESS]=Date.now()}},D=g;D.keysPressed=new Set,D.mouseDown=!1,D.mouseX=0,D.mouseY=0;var L=D;var _=class{static init(t){this.instructions=t,Object.keys(t).forEach(r=>{let s=t[r].opcode;this.instructionsToOpcodes.set(r,s),this.opcodesToInstructions.set(s,r)})}static step(){L.updateInputs();let t=this.advanceProgramCounter(),r=this.opcodesToInstructions.get(t);if(!r)throw new Error(`Unknown opcode '${t}'`);let s=this.instructions[r].operands.map(()=>this.advanceProgramCounter());this.instructions[r].execute.apply(null,s)}static advanceProgramCounter(){if(this.programCounter<e.PROGRAM_MEMORY_START||this.programCounter>=e.PROGRAM_MEMORY_END)throw new Error(`program counter outside valid program memory region at ${this.programCounter}`);return E.get(this.programCounter++)}static reset(){this.programCounter=e.PROGRAM_MEMORY_START,this.halted=!1,this.running=!1}};_.programCounter=e.PROGRAM_MEMORY_START,_.running=!1,_.halted=!1,_.instructionsToOpcodes=new Map,_.opcodesToInstructions=new Map;var V=_;var k=window.AudioContext||window.webkitAudioContext,N={"0":"square","1":"sawtooth","2":"triangle","3":"sine"},C=class{static addAudioChannel(t,r,s){let n=this.audioCtx.createOscillator(),a=this.audioCtx.createGain();n.connect(a),a.connect(this.audioCtx.destination);let d={gain:0,oscillatorType:N["0"],frequency:440};return a.gain.value=d.gain,n.type=d.oscillatorType,n.frequency.value=d.frequency,n.start(),this.audioChannels.push({state:d,waveTypeAddr:t,freqAddr:r,volAddr:s,gainNode:a,oscillatorNode:n})}static updateAudio(){this.audioChannels.forEach(t=>{let r=(E.ram[t.freqAddr]||0)/1e3,s=V.running?(E.ram[t.volAddr]||0)/100*this.MAX_GAIN:0,n=N[E.ram[t.waveTypeAddr]]||N["0"],{state:a}=t;a.gain!==s&&(t.gainNode.gain.setValueAtTime(s,this.audioCtx.currentTime),a.gain=s),a.oscillatorType!==n&&(t.oscillatorNode.type=n,a.oscillatorType=n),a.frequency!==r&&(t.oscillatorNode.frequency.setValueAtTime(r,this.audioCtx.currentTime),a.frequency=r)})}static init(){this.addAudioChannel(e.AUDIO_CH1_WAVE_TYPE_ADDRESS,e.AUDIO_CH1_FREQUENCY_ADDRESS,e.AUDIO_CH1_VOLUME_ADDRESS),this.addAudioChannel(e.AUDIO_CH2_WAVE_TYPE_ADDRESS,e.AUDIO_CH2_FREQUENCY_ADDRESS,e.AUDIO_CH2_VOLUME_ADDRESS),this.addAudioChannel(e.AUDIO_CH3_WAVE_TYPE_ADDRESS,e.AUDIO_CH3_FREQUENCY_ADDRESS,e.AUDIO_CH3_VOLUME_ADDRESS)}};C.MAX_GAIN=.15,C.audioChannels=[],C.audioCtx=new k;var v=C;function G(i,t){if(m.init(i),m.initScreen(f,I,y),m.initUI(t),l.init(i),l.loadProgramAndReset(),!document.body)throw new Error("DOM not ready");function r(){if(!document.body)throw new Error("DOM not ready");document.body.removeEventListener("click",r),v.audioCtx.resume()}return document.body.addEventListener("click",r),{selectProgram:()=>m.selectProgram(),loadProgramAndReset:()=>l.loadProgramAndReset(),runStop:()=>l.runStop(),stepOnce:()=>l.stepOnce(),editProgramText:()=>m.editProgramText(),setSpeed:()=>m.setSpeed(),setFullSpeed:()=>m.setFullSpeed()}}export{G as default};
